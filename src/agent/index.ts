import { StateGraph, START, END } from "@langchain/langgraph";
import { AgentState } from "./state";
import { plannerNode } from "./nodes/plannerNode";
import { executorNode } from "./nodes/executorNode";

// 1. –õ–û–ì–ò–ö–ê –ü–ï–†–ï–•–û–î–û–í (Router)
// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–º–æ—Ç—Ä–∏—Ç –≤ "–ø–∞–º—è—Ç—å" (state) –∏ —Ä–µ—à–∞–µ—Ç:
// –ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –¥–∞–ª—å—à–µ –∏–ª–∏ –º–æ–∂–Ω–æ –∏–¥—Ç–∏ –ø–∏—Ç—å –∫–æ—Ñ–µ?
function shouldContinue(state: typeof AgentState.State) {
  const { plan } = state;

  // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –ø–ª–∞–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤ –Ω–µ–º –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã
  if (plan && plan.length > 0) {
    console.log(`üîÑ –û—Å—Ç–∞–ª–æ—Å—å –∑–∞–¥–∞—á: ${plan.length}. –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é.`);
    return "executor"; // –ö–æ–º–∞–Ω–¥–∞ –≥—Ä–∞—Ñ—É: "–ò–¥–∏ –≤ —É–∑–µ–ª executor"
  }

  // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –ø—É—Å—Ç
  console.log("‚úÖ –ü–ª–∞–Ω –ø—É—Å—Ç. –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.");
  return END; // –ö–æ–º–∞–Ω–¥–∞ –≥—Ä–∞—Ñ—É: "–ó–∞–≤–µ—Ä—à–∞–π —Ä–∞–±–æ—Ç—É"
}

// 2. –°–ë–û–†–ö–ê –ì–†–ê–§–ê
const workflow = new StateGraph(AgentState)
  
  // --- –î–æ–±–∞–≤–ª—è–µ–º –£–∑–ª—ã (Nodes) ---
  .addNode("planner", plannerNode)   // –£–∑–µ–ª 1: DeepSeek-–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
  .addNode("executor", executorNode) // –£–∑–µ–ª 2: DeepSeek-–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å + –¢–µ—Ä–º–∏–Ω–∞–ª

  // --- –°—Ç—Ä–æ–∏–º –†–µ–±—Ä–∞ (Edges) ---
  
  // –°—Ç–∞—Ä—Ç -> –°—Ä–∞–∑—É –∏–¥–µ–º –∫ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫—É
  .addEdge(START, "planner")

  // –ü–æ—Å–ª–µ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ -> –í—Å–µ–≥–¥–∞ –∏–¥–µ–º –∫ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é (–Ω–∞—á–∞—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É)
  .addEdge("planner", "executor")

  // –ü–æ—Å–ª–µ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è -> –í–∫–ª—é—á–∞–µ–º –º–æ–∑–≥ (—É—Å–ª–æ–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥)
  .addConditionalEdges(
    "executor",       // –û—Ç–∫—É–¥–∞ –≤—ã—Ö–æ–¥–∏–º (–ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏)
    shouldContinue,   // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
    ["executor", END] // –í–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø—É—Ç–∏ (–¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
  );

// 3. –ö–û–ú–ü–ò–õ–Ø–¶–ò–Ø –ò –≠–ö–°–ü–û–†–¢
// checkpointer –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ, –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
export const app = workflow.compile();